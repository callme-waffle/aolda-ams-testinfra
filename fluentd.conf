# Fluentd Configuration
# Based on original OpenStack Kolla configuration
# Output: Loki (172.32.0.247:3100)

# ============================================================================
# INPUTS - Level 0 (Infrastructure)
# ============================================================================

# MariaDB Logs
<source>
  @type tail
  path /var/log/kolla/mariadb/mariadb.log
  pos_file /var/run/fluentd/mariadb.pos
  tag infra.mariadb
  enable_watch_timer false
  <parse>
    @type multiline
    format_firstline /^(\d{4}-\d{2}-\d{2}|\d{6}) /
    format1 /^(?<Payload>.*)/
  </parse>
</source>

# MariaDB Xinetd Logs
<source>
  @type tail
  path /var/log/kolla/mariadb/xinetd.log
  pos_file /var/run/fluentd/mariadb-xinetd.pos
  tag infra.mariadb-xinetd
  ignore_repeated_permission_error true
  enable_watch_timer false
  <parse>
    @type multiline
    format_firstline /^\d{2}\/\d{1,2}\/\d{1,2}@\d{1,2}:\d{1,2}:\d{1,2}\: (START|EXIT)\: /
    format1 /^(?<Timestamp>\S+) (?<Payload>.*)?$/
    time_key Timestamp
    keep_time_key true
    time_format %y/%m/%d@%T
  </parse>
</source>

# MariaDB Cluster Check Logs
<source>
  @type tail
  path /var/log/kolla/mariadb/mariadb-clustercheck.log
  pos_file /var/run/fluentd/mariadb-clustercheck.pos
  tag infra.mariadb-clustercheck
  ignore_repeated_permission_error true
  enable_watch_timer false
  <parse>
    @type regexp
    expression /^(?<Payload>.*)$/
  </parse>
</source>

# RabbitMQ Logs
<source>
  @type tail
  path /var/log/kolla/rabbitmq/rabbit@aolda-control.log
  pos_file /var/run/fluentd/rabbit.pos
  tag infra.rabbit
  enable_watch_timer false
  <parse>
    @type multiline
    format_firstline /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}(\d+\+\d{2}:\d{2})?/
    format1 /^(?<Timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})(\d+\+\d{2}:\d{2})? \[(?<log_level>\w+)\] (?<Payload>.*)/
  </parse>
</source>

# Libvirt Logs
<source>
  @type tail
  path /var/log/kolla/libvirt/libvirtd.log
  pos_file /var/run/fluentd/libvirt.pos
  tag infra.libvirt
  enable_watch_timer false
  <parse>
    @type regexp
    expression /^(?<Timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}.\d{3}\+\d{4}): (?<Pid>\d+): (?<log_level>\S+) : (?<Payload>.*)?$/
    time_key Timestamp
    time_format %F %T.%L%z
  </parse>
</source>

# OpenVSwitch vswitchd Logs
<source>
  @type tail
  path /var/log/kolla/openvswitch/ovs-vswitchd.log
  pos_file /var/run/fluentd/openvswitch.pos
  tag infra.openvswitch
  enable_watch_timer false
  <parse>
    @type multiline
    format_firstline /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}/
    format1 /^(?<Timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3})Z\|\d{5,}\|(?<module>\S+)\|(?<log_level>\S+)\|(?<Payload>.*)/
    time_key Timestamp
    time_format %FT%T.%L
  </parse>
</source>

# OpenVSwitch DB Server Logs
<source>
  @type tail
  path /var/log/kolla/openvswitch/ovsdb-server.log
  pos_file /var/run/fluentd/openvswitchdb.pos
  tag infra.openvswitchdb
  enable_watch_timer false
  <parse>
    @type multiline
    format_firstline /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}/
    format1 /^(?<Timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3})Z\|\d{5,}\|(?<module>\S+)\|(?<log_level>\S+)\|(?<Payload>.*)/
    time_key Timestamp
    time_format %FT%T.%L
  </parse>
</source>

# Systemd Journal
<source>
  @type systemd
  tag journal
  path /var/log/journal
  <entry>
    fields_strip_underscores true
    fields_lowercase true
  </entry>
</source>

# Syslog
<source>
  @type syslog
  port 5140
  bind 172.16.10.12
  tag syslog
  severity_key log_level
  source_hostname_key Hostname
  <parse>
    @type regexp
    expression /^(?<Payload>.*)$/
  </parse>
</source>

# Redis Logs
<source>
  @type tail
  path /var/log/kolla/redis/redis.log
  pos_file /var/run/fluentd/redis.pos
  tag infra.redis
  ignore_repeated_permission_error true
  enable_watch_timer false
  <parse>
    @type regexp
    expression /^(?:(?<Pid>\d+):(?<Role>[SCMX])\s+(?<Timestamp>\d{1,2}\s+\w{3}\s+\d{4}\s+\d{2}:\d{2}:\d{2}\.\d{3})\s+[*#]\s+)?(?<Payload>.*)$/
    time_key Timestamp
    time_format %d %b %Y %H:%M:%S.%L
    types Pid:integer
  </parse>
</source>

# Redis Sentinel Logs
<source>
  @type tail
  path /var/log/kolla/redis/redis-sentinel.log
  pos_file /var/run/fluentd/redis-sentinel.pos
  tag infra.redis-sentinel
  ignore_repeated_permission_error true
  enable_watch_timer false
  <parse>
    @type regexp
    expression /^(?:(?<Pid>\d+):(?<Role>[SCMX])\s+(?<Timestamp>\d{1,2}\s+\w{3}\s+\d{4}\s+\d{2}:\d{2}:\d{2}\.\d{3})\s+[*#]\s+)?(?<Payload>.*)$/
    time_key Timestamp
    time_format %d %b %Y %H:%M:%S.%L
    types Pid:integer
  </parse>
</source>

# ============================================================================
# INPUTS - Level 1 (OpenStack Services)
# ============================================================================

# OpenStack Service Logs (Python services)
<source>
  @type tail
  path /var/log/kolla/cinder/*.log,/var/log/kolla/glance/*.log,/var/log/kolla/heat/*.log,/var/log/kolla/keystone/*.log,/var/log/kolla/masakari/*.log,/var/log/kolla/neutron/*.log,/var/log/kolla/nova/*.log,/var/log/kolla/placement/*.log
  exclude_path ["/var/log/kolla/neutron/dnsmasq.log",
                "/var/log/kolla/ironic/dnsmasq.log",
                "/var/log/kolla/*/*-access.log",
                "/var/log/kolla/*/*-error.log",
                "/var/log/kolla/*/*_access.log",
                "/var/log/kolla/*/*_error.log",
                "/var/log/kolla/*/*-uwsgi.log"]
  pos_file /var/run/fluentd/kolla-openstack.pos
  tag kolla.*
  ignore_repeated_permission_error true
  enable_watch_timer false
  <parse>
    @type multiline
    format_firstline /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}.\d{3} \d+ \S+ \S+ \[.*\]/
    format1 /^(?<Timestamp>\S+ \S+) (?<Pid>\d+) (?<log_level>\S+) (?<python_module>\S+) ((?:\[)(?:None|req-)(?<global_request_id>\S+)? (?:None|req-)(?<request_id>\S+) (?<user_id>\S+) (?<tenant_id>\S+) (?<domain_id>\S+) (?<system_scope>\S+) (?<user_domain>\S+) (?<project_domain>\S+)(?:\]))?(?<Payload>.*)?$/
    time_key Timestamp
    keep_time_key true
    time_format %F %T.%L
  </parse>
</source>

# Apache and WSGI Access/Error Logs
<source>
  @type tail
  path /var/log/kolla/*/*-access.log,/var/log/kolla/*/*-error.log,/var/log/kolla/*/*_access.log,/var/log/kolla/*/*_error.log
  pos_file /var/run/fluentd/kolla-openstack-wsgi.pos
  tag kolla.*
  enable_watch_timer false
  <parse>
    @type regexp
    expression /^(?<Payload>.*)$/
  </parse>
</source>

# UWSGI Logs
<source>
  @type tail
  path /var/log/kolla/cinder/*-uwsgi.log,/var/log/kolla/glance/*-uwsgi.log,/var/log/kolla/heat/*-uwsgi.log,/var/log/kolla/keystone/*-uwsgi.log,/var/log/kolla/masakari/*-uwsgi.log,/var/log/kolla/neutron/*-uwsgi.log,/var/log/kolla/nova/*-uwsgi.log,/var/log/kolla/placement/*-uwsgi.log
  pos_file /var/run/fluentd/kolla-uwsgi.pos
  tag kolla.*
  ignore_repeated_permission_error true
  enable_watch_timer false
  <parse>
    @type regexp
    expression /^(?:\[pid: (?<Pid>\d+)\|app: (?<App>\d+)\|req: (?<Req>\d+\/\d+)\] (?<Address>\S+) \((?<User>\w*)\) \{(?<Vars>\d+) vars +in (?<Bytes>\d+) bytes\} \[(?<Timestamp>\w+ \w+\s+\d+ \d+:\d+:\d+ \d+)\] )?(?<Payload>.*)$/
    time_key Timestamp
    keep_time_key true
    time_format %c
  </parse>
</source>

# ============================================================================
# FILTERS - Add metadata and transform tags
# ============================================================================

# Extract service name from tag and add metadata for OpenStack services
<filter kolla.var.log.kolla.*.*.log>
  @type record_transformer
  <record>
    Hostname ${hostname}
    Logger openstack.${tag_parts[4]}
    programname ${tag_parts[5]}
    type info
    level lv1
    source ${tag_parts[4]}
  </record>
</filter>

# Add metadata for infrastructure services
<filter infra.**>
  @type record_transformer
  <record>
    Hostname ${hostname}
    programname ${tag_parts[1]}
    type info
    level lv0
    source ${tag_parts[1]}
  </record>
</filter>

# Retag MariaDB logs according to log format
<match infra.mariadb>
  @type rewrite_tag_filter
  <rule>
    key Payload
    pattern /^\d{6}/
    tag infra.mariadb.mysqld_safe
  </rule>
  <rule>
    key Payload
    pattern /^\d{4}-\d{2}-\d{2}/
    tag infra.mariadb.mysqld
  </rule>
</match>

# Parse MariaDB logs with 6 digit date format (mysqld_safe)
<filter infra.mariadb.mysqld_safe>
  @type parser
  format /^(?<Timestamp>\d{6} {1,2}\d{1,2}:\d{1,2}:\d{1,2}) +(?<Payload>mysqld_safe .*)/
  time_format %y%m%d %k:%M:%S
  time_key Timestamp
  key_name Payload
  reserve_data true
</filter>

# Parse MariaDB logs with 8 digit date format (mysqld)
<filter infra.mariadb.mysqld>
  @type parser
  format /^(?<Timestamp>\d{4}-\d{2}-\d{2} {1,2}\d{1,2}:\d{1,2}:\d{1,2}) +(?<Payload>\w+ +(\[(?<log_level>\w+)\]|\w+: +(?<log_level>\w+):).*)/
  time_format %Y-%m-%d %k:%M:%S
  time_key Timestamp
  key_name Payload
  reserve_data true
</filter>

# Re-add timestamp record for MariaDB
<filter infra.mariadb.*>
  @type record_transformer
  <record>
    timestamp ${time}
  </record>
</filter>

# Add metadata for syslog
<filter syslog.**>
  @type record_transformer
  <record>
    type info
    level lv0
    source syslog
  </record>
</filter>

# Add metadata for systemd journal
<filter journal.**>
  @type record_transformer
  <record>
    type info
    level lv0
    source systemd
  </record>
</filter>

# Add metadata for Apache/WSGI Access/Error logs
<filter kolla.var.log.kolla.*.*-access.log>
  @type record_transformer
  <record>
    Hostname ${hostname}
    Logger apache.${tag_parts[4]}
    programname ${tag_parts[5]}
    type info
    level lv1
    source ${tag_parts[4]}
  </record>
</filter>

<filter kolla.var.log.kolla.*.*-error.log>
  @type record_transformer
  <record>
    Hostname ${hostname}
    Logger apache.${tag_parts[4]}
    programname ${tag_parts[5]}
    type info
    level lv1
    source ${tag_parts[4]}
  </record>
</filter>

<filter kolla.var.log.kolla.*.*_access.log>
  @type record_transformer
  <record>
    Hostname ${hostname}
    Logger wsgi.${tag_parts[4]}
    programname ${tag_parts[5]}
    type info
    level lv1
    source ${tag_parts[4]}
  </record>
</filter>

<filter kolla.var.log.kolla.*.*_error.log>
  @type record_transformer
  <record>
    Hostname ${hostname}
    Logger wsgi.${tag_parts[4]}
    programname ${tag_parts[5]}
    type info
    level lv1
    source ${tag_parts[4]}
  </record>
</filter>

# Add metadata for UWSGI logs
<filter kolla.var.log.kolla.*.*-uwsgi.log>
  @type record_transformer
  <record>
    Hostname ${hostname}
    Logger uwsgi.${tag_parts[4]}
    programname ${tag_parts[5]}
    type info
    level lv1
    source ${tag_parts[4]}
  </record>
</filter>

# ============================================================================
# OUTPUT - Loki
# ============================================================================

<match **>
  @type loki
  url http://172.32.0.247:3100
  <label>
    type ${record["type"]}
    level ${record["level"]}
    source ${record["source"]}
  </label>
  <buffer>
    @type file
    path /var/lib/fluentd/buffer/loki
    flush_interval 10s
    chunk_limit_size 1M
    retry_max_times 3
  </buffer>
</match>
